<!DOCTYPE html>
<html lang="ja-jp">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" [テスト投稿]Lodgeをherokuで動かす(ついでにheroku button) &middot;  hoshinotsuyoshi.com" />
  	<meta property="og:site_name" content="hoshinotsuyoshi.com" />
  	<meta property="og:url" content="https://hoshinotsuyoshi.com/post/logde-heroku/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2014-09-16T00:00:00&#43;09:00" />

    
    <meta property="og:article:tag" content="logde" />
    
    <meta property="og:article:tag" content="heroku" />
    
    

  <title>
     [テスト投稿]Lodgeをherokuで動かす(ついでにheroku button) &middot;  hoshinotsuyoshi.com
  </title>

    <meta name="description" content="ブログだよ" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://hoshinotsuyoshi.com/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://hoshinotsuyoshi.com/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="https://hoshinotsuyoshi.com/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://hoshinotsuyoshi.com/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://hoshinotsuyoshi.com/index.xml" rel="alternate" type="application/rss+xml" title="hoshinotsuyoshi.com" />
      
      
    
    <meta name="generator" content="Hugo 0.17" />

    <link rel="canonical" href="https://hoshinotsuyoshi.com/post/logde-heroku/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-87800718-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="https://hoshinotsuyoshi.com/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




  
  <header class="main-header post-head" style="background-image: url(https://hoshinotsuyoshi.com/images/tokyo.jpg)">
  
  <nav class="main-nav overlay clearfix">


  
      <a class="blog-logo" href="https://hoshinotsuyoshi.com/"><img src="https://hoshinotsuyoshi.com/images/hoshinotsuyoshi.png" alt="Home" /></a>
  
  
      <a class="menu-button icon-feed" href="https://hoshinotsuyoshi.com/index.xml">&nbsp;&nbsp;Subscribe</a>
  
  </nav>
</header>



<main class="content" role="main">




  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">[テスト投稿]Lodgeをherokuで動かす(ついでにheroku button)</h1>
        <small></small>

        <section class="post-meta">
        
          <time class="post-date" datetime="2014-09-16T00:00:00&#43;09:00">
            Sep 16, 2014
          </time>
        
         
          <span class="post-tag small"><a href="https://hoshinotsuyoshi.com/tags/logde/">#logde</a></span>
         
          <span class="post-tag small"><a href="https://hoshinotsuyoshi.com/tags/heroku/">#heroku</a></span>
         
        </section>
    </header>

    <section class="post-content">
      <p>Lodgeをherokuで動かす(ついでにheroku button)</p>

<h2 id="lodgeとは">Lodgeとは</h2>

<p>Lodgeは、オープンソースの情報共有アプリです。</p>

<p></p>

<ul>
<li><a href="https://github.com/lodge/lodge">lodge/lodge</a></li>
<li><a href="http://qiita.com/m-yamashita/items/d6f64db461acd54095f7">無料でイントラネット内にナレッジ/ノウハウの共有ができる「Lodge」</a></li>
</ul>

<h2 id="herokuにデプロイしてみた">herokuにデプロイしてみた</h2>

<p>「データを外部業者に預けずにオンプレで管理できる」のが特色のlodgeを、クラウド環境にデプロイするのは色々と相反している気もしますが、気にしない方針でいきます。
あとついでにheroku buttonを使ってみました。</p>

<h2 id="こんな感じで編集しました">こんな感じで編集しました</h2>

<p><a href="https://github.com/hoshinotsuyoshi/lodge/commit/41d71fb77b82e287506d727dfacbc3e08d6dc80d">https://github.com/hoshinotsuyoshi/lodge/commit/41d71fb77b82e287506d727dfacbc3e08d6dc80d</a></p>

<h2 id="つまり-やったこと">つまり、やったこと</h2>

<ul>
<li>環境変数設定を

<ul>
<li>app.jsonに一部書く</li>
<li>config/environments/production.rbに一部書く</li>
</ul></li>
<li>bundle installしてGemfile.lockを.gitignoreから外す</li>
<li>config/database.ymlを書いて.gitignoreから外す</li>
<li>自分のlodgeのREADME.mdにheroku buttonを追加</li>
</ul>

<h2 id="herokuボタンを押した後の流れ">herokuボタンを押した後の流れ</h2>

<p>github上でforkしてローカルから自分のlodgeにpushしたのがこちらになります。</p>

<p><a href="https://github.com/hoshinotsuyoshi/lodge/tree/heroku_button">https://github.com/hoshinotsuyoshi/lodge/tree/heroku_button</a></p>

<p>さっきREADMEに置いたherokuボタンを押します。
herokuボタンを押したあとは、普通にherokuボタンデプロイの流れです。</p>

<p>こんな画面。
App Nameを入力すると(必須ではない)その名前がサブドメインの名前(xxx.herokuapp.comのホスト名)になります。</p>

<p><img src="https://i.gyazo.com/c8b416da124962d952c94265e36d5b59.png" alt="new" /></p>

<p>下のほうでデプロイボタンを押します。環境変数を編集したりしてもいいですが、基本的にそのままで動くはずです。</p>

<p><img src="https://i.gyazo.com/bf7b70d490b750dcad55917dd0281102.png" alt="deploy" /></p>

<p>しばらく待ちます。assets:precompileとかmigrateとかが正常終了するとこうなります。</p>

<p><img src="https://i.gyazo.com/195f6df196ffdee5be8be6818b803555.png" alt="" /></p>

<p>「View it」を叩くと、デプロイされたlodgeのトップ画面に飛びます。
<img src="https://i.gyazo.com/a01cec51256387f50967199565fa00a9.png" alt="" /></p>

<p>注意としては、無料といえどアドオンを使っていること、cleardb（mysqlアドオン）は無料だと5MBしか使えないので、そのままだとビジネス用途は難しいと思います。
sendgridも一日の送信数とかが割りと少なかったはず。</p>

<p>以上です。</p>

<h2 id="参考">参考</h2>

<ul>
<li><a href="http://qiita.com/tukiyo3/items/58d3599d848fc55eb604">http://qiita.com/tukiyo3/items/58d3599d848fc55eb604</a></li>
<li><a href="http://www.moongift.jp/2014/07/lodge-%E7%A4%BE%E5%86%85%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8B%E3%83%8A%E3%83%AC%E3%83%83%E3%82%B8%E5%85%B1%E6%9C%89%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9/">http://www.moongift.jp/2014/07/lodge-%E7%A4%BE%E5%86%85%E3%81%A7%E4%BD%BF%E3%81%88%E3%82%8B%E3%83%8A%E3%83%AC%E3%83%83%E3%82%B8%E5%85%B1%E6%9C%89%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9/</a></li>
<li><a href="http://blog.a-know.me/entry/2014/09/14/124323">http://blog.a-know.me/entry/2014/09/14/124323</a></li>
</ul>

<h2 id="以下-蛇足的メモ">以下、蛇足的メモ</h2>

<h2 id="herokuにデプロイするために編集したこと詳細">herokuにデプロイするために編集したこと詳細</h2>

<h4 id="gitignore">.gitignore</h4>

<p>herokuにデプロイするために、Gemfile.lockとconfig/database.ymlをignore対象から外します。</p>

<pre><code class="language-diff">diff --git a/.gitignore b/.gitignore
index 5271928..710789e 100644
--- a/.gitignore
+++ b/.gitignore
@@ -23,9 +23,6 @@
 /log/*.log
 /tmp
 
-/config/database.yml
-
-/Gemfile.lock
 /vendor/bundle
 lodge_development
 lodge_test
@@ -40,4 +37,4 @@ public/uploads/
 .env
 
 # Mac finder artifacts
-.DS_Store
\ No newline at end of file
+.DS_Store
</code></pre>

<h4 id="gemfile">Gemfile</h4>

<p>データベースのアダプタを自動判定している部分をmysqlに決めうちしてしまいます
(postgresはちょっと詳しくないので、、)</p>

<pre><code class="language-diff">diff --git a/Gemfile b/Gemfile
index f861c18..848d4b2 100644
--- a/Gemfile
+++ b/Gemfile
@@ -96,30 +96,4 @@ group :test do
   gem 'launchy'
 end
 
-# Include database gems for the adapters found in the database
-# configuration file
-require 'erb'
-require 'yaml'
-database_file = File.join(File.dirname(__FILE__), &quot;config/database.yml&quot;)
-if File.exist?(database_file)
-  database_config = YAML::load(ERB.new(IO.read(database_file)).result)
-  adapters = database_config.values.map {|c| c['adapter']}.compact.uniq
-  if adapters.any?
-    adapters.each do |adapter|
-      case adapter
-      when 'mysql2'
-        gem &quot;mysql2&quot;, '~&gt; 0.3'
-      when /postgresql/
-        gem &quot;pg&quot;, '~&gt; 0.17'
-      when /sqlite3/
-        gem &quot;sqlite3&quot;, '~&gt; 1.3'
-      else
-        warn(&quot;Unknown database adapter `#{adapter}` found in config/database.yml&quot;)
-      end
-    end
-  else
-    warn(&quot;No adapter found in config/database.yml, please configure it first&quot;)
-  end
-else
-  warn(&quot;Please configure your config/database.yml first&quot;)
-end
+gem 'mysql2'
</code></pre>

<h4 id="gemfile-lock">Gemfile.lock</h4>

<p>bundle install後に追加。</p>

<pre><code class="language-diff">diff --git a/Gemfile.lock b/Gemfile.lock
new file mode 100644
index 0000000..a01e01e
--- /dev/null
+++ b/Gemfile.lock
@@ -0,0 +1,416 @@
+ (省略)
</code></pre>

<h4 id="readme-md">README.md</h4>

<p>herokuボタンのドキュメントを参考に、ボタンを設置</p>

<pre><code class="language-diff">diff --git a/README.md b/README.md
index 4246894..be73a8c 100644
--- a/README.md
+++ b/README.md
@@ -4,6 +4,8 @@ Lodge
 [![Coverage Status](https://coveralls.io/repos/lodge/lodge/badge.png)](https://coveralls.io/r/lodge/lodge)
 [![Code Climate](https://codeclimate.com/github/lodge/lodge/badges/gpa.svg)](https://codeclimate.com/github/lodge/lodge)
 
+[![Deploy](https://www.herokucdn.com/deploy/button.png)](https://heroku.com/deploy)
+
 =====
 
 ## これは何？
</code></pre>

<h4 id="app-json">app.json</h4>

<p>README.mdに書かれている環境変数や、DBとSMTPのアドオンなどを設定します。</p>

<ul>
<li>ポイント

<ul>
<li>cleardbとsendgridはそれぞれmysqlとSMTPのherokuアドオンです（無料プラン）</li>
<li>環境変数LODGE_DOMAINは新規登録時のメールアドレス存在確認時に、コールバックリンクとして利用されます。ドメイン名がわかっている場合は、herokuボタンを押した後に書き換えるといいと思います</li>
<li>GOOGLE_CLIENT_IDとGOOGLE_CLIENT_SECRETは、その認証方式を使わないようであれば、特に埋めなくても大丈夫でした</li>
</ul></li>
</ul>

<pre><code class="language-diff">diff --git a/app.json b/app.json
new file mode 100644
index 0000000..71e5069
--- /dev/null
+++ b/app.json
@@ -0,0 +1,22 @@
+{
+  &quot;addons&quot;: [
+    &quot;cleardb&quot;,
+    &quot;sendgrid&quot;
+  ],
+  &quot;env&quot; : {
+    &quot;LODGE_DOMAIN&quot;              : &quot;example.com&quot;,
+    &quot;SECRET_KEY_BASE&quot;           : &quot;__some_random_string__&quot;,
+    &quot;DEVISE_SECRET_KEY&quot;         : &quot;__some_random_string__&quot;,
+    &quot;GOOGLE_CLIENT_ID&quot;          : &quot;FILL_THE_CLIENT_ID&quot;,
+    &quot;GOOGLE_CLIENT_SECRET&quot;      : &quot;FILL_THE_CLIENT_SECRET&quot;,
+    &quot;DELIVERY_METHOD&quot;           : &quot;smtp&quot;,
+    &quot;MAIL_SENDER&quot;               : &quot;lodge@example.com&quot;,
+    &quot;SMTP_PORT&quot;                 : &quot;587&quot;,
+    &quot;SMTP_AUTH_METHOD&quot;          : &quot;plain&quot;,
+    &quot;SMTP_ENABLE_STARTTLS_AUTO&quot; : &quot;true&quot;,
+    &quot;LODGE_THEME&quot;               : &quot;lodge&quot;
+  },
+  &quot;scripts&quot;: {
+    &quot;postdeploy&quot;: &quot;bundle exec rake db:migrate&quot;
+  }
+}
</code></pre>

<h4 id="config-database-yml">config/database.yml</h4>

<ul>
<li>cleardb(mysqlアドオン)の設定をベタに書きます</li>
</ul>

<pre><code class="language-diff">diff --git a/config/database.yml b/config/database.yml
new file mode 100644
index 0000000..39ac335
--- /dev/null
+++ b/config/database.yml
@@ -0,0 +1,3 @@
+# mysql
+# in heroku, use CLEARDB_DATABASE_URL
+&lt;% ENV['DATABASE_URL'] = ENV['CLEARDB_DATABASE_URL'].to_s.sub(/\Amysql/){'mysql2'} %&gt;
diff --git a/config/environments/production.rb b/config/environments/production.rb
index 7aa2d7b..eaa333a 100644
--- a/config/environments/production.rb
+++ b/config/environments/production.rb
@@ -93,11 +93,11 @@ Rails.application.configure do
   # SMTPの指定
   config.action_mailer.delivery_method = ENV[&quot;DELIVERY_METHOD&quot;].to_sym
   config.action_mailer.smtp_settings = {
-    :address              =&gt; ENV[&quot;SMTP_ADDRESS&quot;],
+    :address              =&gt; 'smtp.sendgrid.net',
     :port                 =&gt; ENV[&quot;SMTP_PORT&quot;],
     :domain               =&gt; ENV[&quot;LODGE_DOMAIN&quot;],
-    :user_name            =&gt; ENV[&quot;SMTP_USERNAME&quot;],
-    :password             =&gt; ENV[&quot;SMTP_PASSWORD&quot;],
+    :user_name            =&gt; ENV[&quot;SENDGRID_USERNAME&quot;],
+    :password             =&gt; ENV[&quot;SENDGRID_PASSWORD&quot;],
     :authentication       =&gt; ENV[&quot;SMTP_AUTH_METHOD&quot;].to_sym,
     :enable_starttls_auto =&gt; ENV[&quot;SMTP_ENABLE_STARTTLS_AUTO&quot;],
   }
</code></pre>

<p>元ページ：</p>

<p><a href="http://qiita.com/hoshino/items/e058339f1399baab87b0">http://qiita.com/hoshino/items/e058339f1399baab87b0</a></p>
    </section>


  <footer class="post-footer">


    
    <figure class="author-image">
        <a class="img" href="https://hoshinotsuyoshi.com/" style="background-image: url(https://hoshinotsuyoshi.com/images/hoshinotsuyoshi.png)"><span class="hidden">hoshinotsuyoshi's Picture</span></a>
    </figure>
    

    





<section class="author">
  <h4><a href="https://hoshinotsuyoshi.com/">hoshinotsuyoshi</a></h4>
  
  <p>web application engineer</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Tokyo, Japan</span>
    <span class="author-link icon-link"><a href="https://hoshinotsuyoshi.com">https://hoshinotsuyoshi.com</a></span>
  </div>
</section>



    
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=%5b%e3%83%86%e3%82%b9%e3%83%88%e6%8a%95%e7%a8%bf%5dLodge%e3%82%92heroku%e3%81%a7%e5%8b%95%e3%81%8b%e3%81%99%28%e3%81%a4%e3%81%84%e3%81%a7%e3%81%abheroku%20button%29&nbsp;-&nbsp;hoshinotsuyoshi.com&amp;url=https%3a%2f%2fhoshinotsuyoshi.com%2fpost%2flogde-heroku%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhoshinotsuyoshi.com%2fpost%2flogde-heroku%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fhoshinotsuyoshi.com%2fpost%2flogde-heroku%2f&amp;description=%5b%e3%83%86%e3%82%b9%e3%83%88%e6%8a%95%e7%a8%bf%5dLodge%e3%82%92heroku%e3%81%a7%e5%8b%95%e3%81%8b%e3%81%99%28%e3%81%a4%e3%81%84%e3%81%a7%e3%81%abheroku%20button%29"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fhoshinotsuyoshi.com%2fpost%2flogde-heroku%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



    




  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">hoshinotsuyoshi.com</a> All rights reserved - 2016</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://hoshinotsuyoshi.com/js/jquery.js"></script>
    <script type="text/javascript" src="https://hoshinotsuyoshi.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://hoshinotsuyoshi.com/js/index.js"></script>
    
</body>
</html>


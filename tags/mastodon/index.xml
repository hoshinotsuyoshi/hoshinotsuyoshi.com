<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Mastodon on hoshinotsuyoshi.com</title>
    <link>https://hoshinotsuyoshi.com/tags/mastodon/index.xml</link>
    <description>Recent content in Mastodon on hoshinotsuyoshi.com</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-jp</language>
    <copyright>All rights reserved - 2016</copyright>
    <atom:link href="https://hoshinotsuyoshi.com/tags/mastodon/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>複数mastodonを考える 🐘   🐘   🐘</title>
      <link>https://hoshinotsuyoshi.com/post/multi-mastodon-poor/</link>
      <pubDate>Fri, 28 Apr 2017 14:16:36 +0900</pubDate>
      
      <guid>https://hoshinotsuyoshi.com/post/multi-mastodon-poor/</guid>
      <description>&lt;p&gt;terraformの練習がてら、複数のmastodonインスタンス🐘を立ててみました。&lt;/p&gt;

&lt;p&gt;&lt;/p&gt;

&lt;p&gt;RedisとPostgresの運用をラクしようとするとElastiCacheとRDSを使うことになります。&lt;/p&gt;

&lt;p&gt;しかし、&lt;strong&gt;がんばってRDSを1台で運用&lt;/strong&gt;したとしても、
以下のように、Redisだけで3インスタンス目で38ドルもかかってしまいます。&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;# 🐘&lt;/th&gt;
&lt;th&gt;ElastiCache&lt;/th&gt;
&lt;th&gt;RDS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1台目&lt;/td&gt;
&lt;td&gt;$0/mo.(初年度無料枠)&lt;/td&gt;
&lt;td&gt;$0/mo.(初年度無料枠)&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;2台目&lt;/td&gt;
&lt;td&gt;$19/mo. (無料枠 + 1台)&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;3台目&lt;/td&gt;
&lt;td&gt;$38/mo.(無料枠 + 2台)&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;ケチケチ作戦&#34;&gt;ケチケチ作戦&lt;/h2&gt;

&lt;p&gt;そこで、&lt;strong&gt;Redisも1台だけ&lt;/strong&gt;にしてしまいます。&lt;/p&gt;

&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;# 🐘&lt;/th&gt;
&lt;th&gt;ElastiCache&lt;/th&gt;
&lt;th&gt;RDS&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;

&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1台目&lt;/td&gt;
&lt;td&gt;$0/mo.(初年度無料枠)&lt;/td&gt;
&lt;td&gt;$0/mo.(初年度無料枠)&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;2台目&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;/tr&gt;

&lt;tr&gt;
&lt;td&gt;3台目&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;td&gt;$0/mo.(無料枠1台でがんばる)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;その他はこんな構成です。&lt;/p&gt;

&lt;p&gt;&lt;img alt=&#34;slack&#34; src=&#34;https://hoshinotsuyoshi.com/images/cloudcraft-mastodon.png&#34; width=1600&gt;&lt;/p&gt;

&lt;p&gt;これでEC2代だけになったわ♡ と思ったところ、そんなにうまくはいきませんでした。&lt;/p&gt;

&lt;p&gt;動作確認したところ、&lt;strong&gt;どうも🐘のキャッシュが他の🐘に影響を与えてしまっている&lt;/strong&gt;、、&lt;/p&gt;

&lt;h2 id=&#34;ケチケチ作戦ワークアラウンド&#34;&gt;ケチケチ作戦ワークアラウンド&lt;/h2&gt;

&lt;p&gt;こういうふうにやっていきます。&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-diff&#34;&gt;--- a/config/initializers/redis.rb
+++ b/config/initializers/redis.rb
@@ -4,5 +4,6 @@ Redis.current = Redis.new(
   host: ENV.fetch(&#39;REDIS_HOST&#39;) { &#39;localhost&#39; },
   port: ENV.fetch(&#39;REDIS_PORT&#39;) { 6379 },
   password: ENV.fetch(&#39;REDIS_PASSWORD&#39;) { false },
+  db: ENV.fetch(&#39;REDIS_DB&#39;) { 0 }.to_i,
   driver: :hiredis
 )
diff --git a/streaming/index.js b/streaming/index.js
index a1e7eaca..29ded9e2 100644
--- a/streaming/index.js
+++ b/streaming/index.js
@@ -39,7 +39,8 @@ const wss    = new WebSocket.Server({ server })
 const redisClient = redis.createClient({
   host:     process.env.REDIS_HOST     || &#39;127.0.0.1&#39;,
   port:     process.env.REDIS_PORT     || 6379,
-  password: process.env.REDIS_PASSWORD
+  password: process.env.REDIS_PASSWORD,
+  db:       process.env.REDIS_DB || 0
 })

 const subs = {}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;REDIS_DBという環境変数を誕生させdbを隔離します。&lt;/p&gt;

&lt;p&gt;これでいまんとこ大丈夫だけど、redis詳しくないし、何か間違っている気もする🎲保証はしない&lt;/p&gt;

&lt;p&gt;インスタンスごとに0,1,2,3&amp;hellip;と値を入れます。&lt;/p&gt;

&lt;p&gt;このへんの制御もterraformでやる。&lt;/p&gt;

&lt;h3 id=&#34;まとめ&#34;&gt;✎まとめ&lt;/h3&gt;

&lt;p&gt;terraform楽しいです&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>